// ðŸ“ backend/index.cjs
// ì„œë²„ ì—”íŠ¸ë¦¬: ì¸ì¦(/auth) + ë³´í˜¸ API(/api/*) + SPA ì •ì  ì œê³µ + ëžŒë‹¤ í˜¸ì¶œ

const path = require("path");
const express = require("express");
const cors = require("cors");
const compression = require("compression");
require("dotenv").config();

// === AWS SDK (Lambda / EventBridge) ===
const { LambdaClient, InvokeCommand } = require("@aws-sdk/client-lambda");
const { EventBridgeClient, PutEventsCommand } = require("@aws-sdk/client-eventbridge");

const app = express();
const port = Number(process.env.PORT || 4000);                // Nginx í”„ë¡ì‹œì™€ í†µì¼(4000)
const AWS_REGION = process.env.AWS_REGION || "ap-northeast-2";
const SCHEDULE_FN = process.env.SCHEDULE_FN || "schedule_optimizer";
const EVENT_BUS   = process.env.EVENT_BUS   || "smartfactory-bus";

const lambda = new LambdaClient({ region: AWS_REGION });
const eb     = new EventBridgeClient({ region: AWS_REGION });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ê¸°ë³¸ ì„¤ì •
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.set("trust proxy", true);
app.use(cors());
app.use(compression());
app.use(express.json({ limit: "2mb" }));
app.use(express.urlencoded({ extended: true }));

if (process.env.NODE_ENV !== "production") {
  app.use((req, _res, next) => {
    console.log(`âž¡ ${req.method} ${req.originalUrl}`);
    next();
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ë¼ìš°í„° ë¡œë“œ (ê¸°ì¡´ ìœ ì§€)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const authRoutes         = require("./routes/auth.cjs");
const lineOrderRoutes    = require("./routes/lineOrder.cjs");
const powerTypeRoutes    = require("./routes/powerType.cjs");
const powercustomRoutes  = require("./routes/powercustom.cjs"); // /day-all, /day, /range
const powerDataRoutes    = require("./routes/powerData.cjs");   // /weekly, /monthly

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ë¼ìš°í„° ë§ˆìš´íŠ¸
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use("/auth", authRoutes);               // ë¹„ë³´í˜¸
app.use("/api/equipment",    lineOrderRoutes);
app.use("/api/powertype",    powerTypeRoutes);
app.use("/api/power-custom", powercustomRoutes);
app.use("/api/power-data",   powercustomRoutes); // í˜¸í™˜
app.use("/api/power-data",   powerDataRoutes);

// Alerts ë¼ìš°í„° (ì˜µì…˜)
if (process.env.ALERTS_ENABLED !== "0") {
  try {
    const alertRoutes = require("./routes/alerts.cjs");
    app.use("/api/alerts", alertRoutes);
    console.log("[index] alerts router loaded");
  } catch (e) {
    console.error("[index] alerts router load failed:", e.message);
  }
} else {
  console.log("[index] alerts disabled by env");
}

// live / worksimul (ì˜µì…˜)
try {
  const liveRoutes = require("./routes/live.cjs");         // ë‚´ë¶€ ê²½ë¡œ: /live/price
  app.use("/api", liveRoutes);                             // ìµœì¢… /api/live/price
  console.log("[index] live router loaded");
} catch (e) { console.error("[index] live router load failed:", e.message); }

try {
  const workSimulRoutes = require("./routes/workSimul.cjs"); // ë‚´ë¶€ ê²½ë¡œ: /worksimul
  app.use("/api", workSimulRoutes);                           // ìµœì¢… /api/worksimul
  console.log("[index] workSimul router loaded");
} catch (e) { console.error("[index] workSimul router load failed:", e.message); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// âœ… í—¬ìŠ¤ì²´í¬ (í”„ë¡ì‹œ ì ê²€ìš©)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.get("/api/healthz", (_req, res) => res.json({ ok: true }));
app.get("/healthz",     (_req, res) => res.json({ ok: true })); // ê¸°ì¡´ í˜¸í™˜

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// âœ… ëžŒë‹¤ ìŠ¤ì¼€ì¤„ ìµœì í™” â€” ë™ê¸° í˜¸ì¶œ(í”„ë¡ íŠ¸ ì¦‰ì‹œ ì‘ë‹µ)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.post("/api/schedule/optimize", async (req, res) => {
  try {
    const payload = { detail: req.body }; // ëžŒë‹¤ì—ì„œ event.detail ë¡œ ì½ìŒ
    const out = await lambda.send(new InvokeCommand({
      FunctionName: SCHEDULE_FN,
      Payload: Buffer.from(JSON.stringify(payload)),
    }));
    const raw = out.Payload ? Buffer.from(out.Payload).toString() : "{}";
    let parsed; try { parsed = JSON.parse(raw); } catch { parsed = { raw }; }
    const body = parsed && parsed.body ? JSON.parse(parsed.body) : parsed;
    return res.json(body);
  } catch (err) {
    console.error("[/api/schedule/optimize] invoke error:", err);
    return res.status(500).json({ ok: false, error: "schedule_optimizer invoke failed" });
  }
});

// (ì˜µì…˜) ë¹„ë™ê¸° â€” EventBridgeë¡œ ë˜ì§€ê³  202 ë°˜í™˜
app.post("/api/schedule/optimize/async", async (req, res) => {
  try {
    const entry = {
      EventBusName: EVENT_BUS,
      Source: "smartfactory.ui",
      DetailType: "optimizeScheduleRequested",
      Detail: JSON.stringify(req.body),
    };
    await eb.send(new PutEventsCommand({ Entries: [entry] }));
    return res.status(202).json({ ok: true });
  } catch (err) {
    console.error("[/api/schedule/optimize/async] putEvents error:", err);
    return res.status(500).json({ ok: false, error: "putEvents failed" });
  }
});

// (ì˜µì…˜) /api ì•Œ ìˆ˜ ì—†ëŠ” ê²½ë¡œëŠ” JSON 404
app.use("/api", (_req, res) => res.status(404).json({ ok: false, message: "Not Found" }));

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì •ì  íŒŒì¼ ì œê³µ(ë¦¬ì•¡íŠ¸ ë¹Œë“œ ê²°ê³¼) â€” Nginxê°€ ì œê³µí•˜ë©´ ì£¼ì„ ì²˜ë¦¬ ê°€ëŠ¥
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const distDir = path.join(__dirname, "../femspj/dist");
app.use(express.static(distDir));
app.get("*", (req, res, next) => {
  if (req.path.startsWith("/api/") || req.path.startsWith("/auth/") || req.path === "/healthz") return next();
  res.sendFile(path.join(distDir, "index.html"));
});

// ì—ëŸ¬ í•¸ë“¤ëŸ¬
app.use((err, _req, res, _next) => {
  console.error("ðŸ”¥ Unhandled error:", err);
  res.status(500).json({ ok: false, message: "Internal Server Error" });
});

// ì„œë²„ ì‹œìž‘
app.listen(port, () => console.log(`ðŸš€ server listening on http://localhost:${port}`));
