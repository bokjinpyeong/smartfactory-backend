// ðŸ“ backend/index.cjs â€” ìµœì†Œ ì•ˆì •ë³¸(ë™ê¸° ëžŒë‹¤ë§Œ)
const path = require("path");
const express = require("express");
const cors = require("cors");
const compression = require("compression");
require("dotenv").config();

const { LambdaClient, InvokeCommand } = require("@aws-sdk/client-lambda");

const app = express();
const port = Number(process.env.PORT || 4000);      // Nginx í”„ë¡ì‹œì™€ ì¼ì¹˜
const AWS_REGION = process.env.AWS_REGION || "ap-northeast-2";
const SCHEDULE_FN = process.env.SCHEDULE_FN || "schedule_optimizer";

const lambda = new LambdaClient({ region: AWS_REGION });

// ê¸°ë³¸
app.set("trust proxy", true);
app.use(cors());
app.use(compression());
app.use(express.json({ limit: "2mb" }));
app.use(express.urlencoded({ extended: true }));

if (process.env.NODE_ENV !== "production") {
  app.use((req, _res, next) => { console.log(`âž¡ ${req.method} ${req.originalUrl}`); next(); });
}

// ë¼ìš°í„°(ê¸°ì¡´ ìœ ì§€)
const authRoutes         = require("./routes/auth.cjs");
const lineOrderRoutes    = require("./routes/lineOrder.cjs");
const powerTypeRoutes    = require("./routes/powerType.cjs");
const powercustomRoutes  = require("./routes/powercustom.cjs");
const powerDataRoutes    = require("./routes/powerData.cjs");

app.use("/auth", authRoutes);
app.use("/api/equipment",    lineOrderRoutes);
app.use("/api/powertype",    powerTypeRoutes);
app.use("/api/power-custom", powercustomRoutes);
app.use("/api/power-data",   powercustomRoutes);
app.use("/api/power-data",   powerDataRoutes);

// ì„ íƒ ë¼ìš°í„°(ì‹¤íŒ¨í•´ë„ ì„œë²„ ì£½ì§€ ì•Šê²Œ try-catch)
try { const alertRoutes = require("./routes/alerts.cjs"); app.use("/api/alerts", alertRoutes); } catch(e){ console.error("[alerts] skip:", e.message); }
try { const liveRoutes  = require("./routes/live.cjs");   app.use("/api", liveRoutes); }          catch(e){ console.error("[live] skip:", e.message); }
try { const wsRoutes    = require("./routes/workSimul.cjs"); app.use("/api", wsRoutes); }         catch(e){ console.error("[workSimul] skip:", e.message); }

// í—¬ìŠ¤ì²´í¬
app.get("/api/healthz", (_req,res)=>res.json({ok:true}));
app.get("/healthz",     (_req,res)=>res.json({ok:true}));

// âœ… ìŠ¤ì¼€ì¤„ ìµœì í™”(ë™ê¸°) â€” í”„ë¡ íŠ¸ ì¦‰ì‹œ ì‘ë‹µ
app.post("/api/schedule/optimize", async (req, res) => {
  try {
    const payload = { detail: req.body };
    const out = await lambda.send(new InvokeCommand({
      FunctionName: SCHEDULE_FN,
      Payload: Buffer.from(JSON.stringify(payload)),
    }));
    const raw = out.Payload ? Buffer.from(out.Payload).toString() : "{}";
    let parsed; try { parsed = JSON.parse(raw); } catch { parsed = { raw }; }
    const body = parsed && parsed.body ? JSON.parse(parsed.body) : parsed;
    res.json(body);
  } catch (err) {
    console.error("[/api/schedule/optimize] invoke error:", err);
    res.status(500).json({ ok:false, error:"schedule_optimizer invoke failed" });
  }
});

// /api ê¸°íƒ€ 404
app.use("/api", (_req,res)=>res.status(404).json({ok:false, message:"Not Found"}));

// ì •ì  íŒŒì¼(SPA)
const distDir = path.join(__dirname, "../femspj/dist");
app.use(express.static(distDir));
app.get("*", (req,res,next)=>{
  if (req.path.startsWith("/api/") || req.path.startsWith("/auth/") || req.path === "/healthz") return next();
  res.sendFile(path.join(distDir, "index.html"));
});

// ì„œë²„ ì‹œìž‘
app.listen(port, ()=>console.log(`ðŸš€ server listening on http://localhost:${port}`));
