// ðŸ“ backend/index.cjs
// ì„œë²„ ì—”íŠ¸ë¦¬: /auth(ë¹„ë³´í˜¸) + /api/*(ë³´í˜¸ ë¼ìš°íŠ¸ë“¤) ë“±ë¡, SPA ì •ì  ì œê³µ(ì˜µì…˜)

const path = require("path");
const express = require("express");
const cors = require("cors");
require("dotenv").config();

const app = express();
const port = process.env.PORT || 5000;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ê¸°ë³¸ ì„¤ì •
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.set("trust proxy", true);            // Nginx ë’¤ì— ìžˆì„ ë•Œ í´ë¼ì´ì–¸íŠ¸ IP ë“± ì‹ ë¢°
app.use(cors());                         // í•„ìš”í•˜ë©´ origin í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ë¡œ ì œí•œ
app.use(express.json({ limit: "2mb" })); // JSON ë°”ë”” íŒŒì„œ

// (ì„ íƒ) ìš”ì²­ ë¡œê¹… - ë””ë²„ê·¸ìš©
app.use((req, _res, next) => {
  if (process.env.NODE_ENV !== "production") {
    console.log(`âž¡ ${req.method} ${req.originalUrl}`);
  }
  next();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ë¼ìš°í„° ë¡œë“œ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const authRoutes = require("./routes/auth.cjs");            // ë¡œê·¸ì¸/íšŒì›ê°€ìž…/í”„ë¡œí•„ ë“± (ë¹„ë³´í˜¸)
const lineOrderRoutes = require("./routes/lineOrder.cjs");  // ì„¤ë¹„ ìˆœì„œ (ê° ë¼ìš°íŠ¸ ì•ˆì—ì„œ requireAuth ì‚¬ìš©)
const powerTypeRoutes = require("./routes/powerType.cjs");  // ì „ë ¥ìœ í˜• ì €ìž¥/ì¡°íšŒ API
const powercustomRoutes = require("./routes/powercustom.cjs"); // â˜… ì¶”ê°€: /day-all, /day ì „ìš©

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ë¼ìš°í„° ë§ˆìš´íŠ¸ ìˆœì„œ ì¤‘ìš”: /auth ë¨¼ì €
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use("/auth", authRoutes);
app.use("/api/equipment", lineOrderRoutes);
app.use("/api/powertype", powerTypeRoutes);

// â˜… ì¶”ê°€: í”„ë¡ íŠ¸ ê¸°ì¡´ ê²½ë¡œ(/api/power-data/day-all, /day) ìœ ì§€ìš©
app.use("/api/power-data", powercustomRoutes);

// (ì˜µì…˜) í—¬ìŠ¤ì²´í¬
app.get("/healthz", (_req, res) => res.json({ ok: true }));

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì •ì  íŒŒì¼ ì œê³µ (ë¦¬ì•¡íŠ¸ ë¹Œë“œ ê²°ê³¼ë¬¼) â€” Nginxê°€ ì œê³µí•˜ë©´ ì£¼ì„ ì²˜ë¦¬ ê°€ëŠ¥
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const distDir = path.join(__dirname, "../femspj/dist");
app.use(express.static(distDir));

// SPA ìƒˆë¡œê³ ì¹¨ ëŒ€ì‘
app.get("*", (req, res, next) => {
  // API/AUTH ê²½ë¡œëŠ” íŒ¨ìŠ¤
  if (req.path.startsWith("/api/") || req.path.startsWith("/auth/") || req.path === "/healthz") {
    return next();
  }
  res.sendFile(path.join(distDir, "index.html"));
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì—ëŸ¬ í•¸ë“¤ëŸ¬ (ìµœí›„ì˜ ë³´ë£¨)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use((err, _req, res, _next) => {
  console.error("ðŸ”¥ Unhandled error:", err);
  res.status(500).json({ ok: false, message: "Internal Server Error" });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì„œë²„ ì‹œìž‘
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const powerDataRoutes = require("./routes/powerData.cjs");
app.use("/api/power-data", powerDataRoutes);
app.listen(port, () => {
  console.log(`ðŸš€ server listening on http://localhost:${port}`);
});
